# booster-um
Booster UKI Manager - A simple bash script to manage UKI (Unified Kernel Image) files generated by booster and systemd-ukify.
The script can only be used on Arch Linux.

## Dependencies:
 * Required:
   * booster - Generate initramfs
   * go-yq - Parse booster and booster-um configs
   * system-ukify - Generate UKI files
   * util-linux - Miscellaneous system utilities for Linux
 * Optional:
   * sbctl - Sign UKI files
   * sbsigntools - Sign UKI files with sbsign
   * efibootmgr - Create EFI entries

## Installation
Clone the repo or download the [PKGBUILD](https://github.com/Zile995/booster-um/blob/main/PKGBUILD) and simply run: `makepkg -si`

## Default configuration
* booster-um by default:
  * Signs generated UKI files with `sbctl` **if installed**
  * Uses default splash `/usr/share/systemd/bootctl/splash-arch.bmp`
  * Creates the empty `/etc/kernel/cmdline` if it does not exist
  * Detects the `XBOOTLDR` partition **if it exists and is mounted on** `/boot`
  * Uses default configuration if the `/etc/booster-um.yaml` config **is not valid**
  * Generates UKI in `esp/EFI/Linux` dir. If this directory does not exist, it will be created
  * Removes `vmlinuz-*` and `booster-*` leftovers from `/boot` dir (**microcode** image will not be deleted)
  * Will not create separate fallback images if `universal` flag is enabled in `/etc/booster.yaml` config
  * Will not generate EFI entries or fallback UKI files, by default. EFI entries and fallback UKI files are treated as leftovers.
  * Will not regenerate initramfs files on kernel and extramodule installations/upgrades (they are already generated by **booster hook**)
  * Removes known EFI entries (Example: `\EFI\LINUX\ARCH-LINUX.EFI`) **if efibootmgr is installed**. To prevent this, enable `efistub` in config

* booster-um libalpm hooks by default:
  * Remove EFI entries on kernel removal
  * Remove UKI files from ESP and sbctl database on kernel removal
  * Regenerate UKIs for all installed kernels when booster, microcode, dkms or firmware files are installed, updated, or removed
  * Will not sign generated UKI files on microcode, extramodules (nvidia, nvidia-lts etc.) and kernel updates, sbctl hook will do that
  * Will sign newly created UKI files if they do not exists in the sbctl database. Also, you don't need to manually add UKI files in the sbctl database

* Default `booster-um -G` output and `/boot`|`/esp/EFI/LINUX` content:
  * <details>
    <summary>Generation of UKI files</summary>

    ![generation](https://github.com/Zile995/booster-um/assets/32335484/f072acb4-8fb3-440c-8264-9cd21b7b8333)


    </details>
  * <details>
    <summary>/boot and /esp/EFI/LINUX content</summary>

    ![content](https://github.com/Zile995/booster-um/assets/32335484/fe0a2741-6f13-45a1-b987-93c38fedba29)

    </details>

## Config file
booster-um config file is located at `/etc/booster-um.yaml`. By default it is empty, here is a default configuration:
 ```YAML
 sign_uki: true
 remove_leftovers: true
 generate_fallback: false
 cmdline_per_kernel: false
 splash: /usr/share/systemd/bootctl/splash-arch.bmp
 
 efistub: false
 efistub_config:
   preserve_boot_order: true

 sbsign: false
 sbsign_config:
   pcr_banks: sha1,sha256,sha384,sha512
   pcr_private_key: /path/to/pcr-private-key.pem
   pcr_public_key: /path/to/pcr-public-key.pem
   secureboot_private_key: /path/to/DB.key
   secureboot_certificate: /path/to/DB.crt
 ```

* `sign_uki` manages the UKI signing. If enabled, `sbctl`, or `sbsign`, will sign generated UKI files

* `remove_leftovers` manages the removal of leftovers when generating the UKI files. Besides the vmlinuz and booster files, EFI entries, fallback images and kernel cmdlines are treated as leftovers, they will be removed if `efistub`, `cmdline_per_kernel`, `generate_fallback` options are disabled. If enabled, leftovers will always be removed after generating UKI files. Leftovers will always be removed if you manually delete the UKI for the specified kernel (`booster-um -r`)

* `cmdline_per_kernel` manages the creation of the cmdline per kernel. If enabled, booster-um will will use the kernel parameters from the `/etc/kernel/$pkgbase.cmdline` file. `$pkgbase` is the name of the pacman kernel package name (linux, linux-lts, linux-zen etc.). If this file doesn't exist, booster-um will create it. The default `/etc/kernel/cmdline` will be used as a shared cmdline for all kernels

* `generate_fallback` manages the creation of fallback (universal) UKI files. Separate fallback images will not be created if `universal` flag is enabled in `/etc/booster.yaml` config

* `splash` a picture to display during boot picture. The argument is a path to a BMP file. Default `/usr/share/systemd/bootctl/splash-arch.bmp` picture will be used if this path is invalid or not specified

* `efistub` manages EFI entries. If enabled, booster-um will create a new EFI entry. Also, the booster-um will by default preserve old boot order and add the newly created EFI entry at the **end** of the boot order
* `efistub_config` node provides additional efistub configuration. It is currently possible to control addition of newly created efi entries to the current boot order:
  * `preserve_boot_order` preserves the old boot order. If enabled, newly created EFI entries will be added to the end of the boot order, otherwise they will be added to the beginning

* `sbsign` manages UKI signing using the `sbsign` tool. If enabled, `sbsign` will be used instead of `sbctl`. After enabling this type of signing, the options in the `sbsign_config` node can be set arbitrarily
* `sbsign_config` node provides `sbsign` configuration:
  * `pcr_banks` a comma separated list of PCR banks to sign a policy for
  * `pcr_private_key` a path to a private key to use for signing PCR policies
  * `pcr_public_key` a path to public key to use for signing PCR policies
  * `secureboot_private_key` a path to a private key to use for signing of the UKI file
  * `secureboot_certificate` a path to a certificate to use for signing of UKI file
 
## First run
* Create and edit the `/etc/kernel/cmdline` file. Take care to remove entries pointing to **microcode, vmlinuz and initramfs**. Here is a simple cmdline example (Change the `root=` parameter to reflect your Linux root partitions):
  ```Shell
  root=UUID=0a3407de-014b-458b-b5c1-848e92a327a3 rw quiet splash
  ```
* Edit the `/etc/booster-um.yaml` config if needed. Empty config file will use the default configuration:
  * If you use the EFISTUB booting, add the `efistub: true` to the config
  * If you don't have secureboot keys and `sbctl` is installed, generate them with `sbctl` before generating the UKI files. `booster-um` will by default sign the UKI files with `sbctl` tool if it is installed. If you don't like that, set the `sign_uki: false` to the config. 
  * If you want to use the manually generated keys, use the `sbsign` tools instead of the `sbctl`. Install the `sbsigntools` and set the `sbsign: true` to the config. The `sign_uki` must not be disabled and you will need to provide the appropriate key paths within the `sbsign_config` node (usually `secureboot_private_key` and `secureboot_certificate` fields	need to be configured)
  * For more information on creating secureboot keys, see the [UEFI/Secure Boot](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot) article
* Optionally you can delete the initramfs files of other generators, as well as the entire `esp/EFI/Linux` directory, simply by running `booster-um -R -F`
* Regenerate all images with `booster-um -G`
* If you have enabled the creation of EFI entries, you may need to change the boot order after generating the UKI files. You can change it like this (put your boot numbers here): `efibootmgr -o 3,1,0`
* `systemd-boot` will, if installed, detect UKI files generated by booster-um. For more information about booting, see the [Unified kernel image - Booting](https://wiki.archlinux.org/title/Unified_kernel_image#Booting) article

## Usage (help output)
```Shell
Usage: booster-um [OPTIONS] <package>

Generate or remove booster UKI files.

Help options:
    -h, --help  Show this help message

Generate options:
    -g package  Generate UKI file for specified kernel package name
    -G          Generate UKI files for all installed kernels

Remove options:
    -r package  Remove UKI file for specified kernel package name
    -R          Remove all known booster-*, vmlinuz-* files from /boot and all known files from esp/EFI/Linux dir
    -R -F       Remove all mentioned files + other initramfs* files from /boot and entire esp/EFI/Linux dir

Examples: booster-um -g linux
          booster-um -r linux
          booster-um -G
          booster-um -R
          booster-um -R -F
```
