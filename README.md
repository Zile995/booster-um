# booster-um
Booster UKI Manager - A simple bash script to manage UKI (Unified Kernel Image) files generated by booster and systemd-ukify.
The script can only be used on Arch Linux.

<h2>
    Table of Contents
</h2>

* [Dependencies](#dependencies)
* [Installation](#installation)
* [Default configuration](#default_config)
* [Config file](#config_file)
* [First run](#first_run)
* [Usage (help output)](#usage)

<h2 name="dependencies">
    Dependencies
</h2>

 * Required:
   * booster - Generate initramfs
   * go-yq - Parse booster and booster-um configs
   * system-ukify - Generate UKI files
   * util-linux - Miscellaneous system utilities for Linux
 * Optional:
   * sbctl - Sign UKI files
   * sbsigntools - Sign UKI files with sbsign
   * efibootmgr - Create EFI entries

<h2 name="installation">
    Installation
</h2>

If you are using an Arch-based distribution, install [booster-um](https://aur.archlinux.org/packages/booster-um) or [booster-um-git](https://aur.archlinux.org/packages/booster-um-git) package from the AUR. After that you are free to remove `mkinitcpio`.

<h2 name="default_config">
    Default configuration
</h2>

* booster-um by default:
  * Signs generated UKI files with `sbctl` **if installed**
  * Uses default splash `/usr/share/systemd/bootctl/splash-arch.bmp`
  * Creates the empty `/etc/kernel/cmdline` if it does not exist.
  * Uses the `/proc/cmdline` if the cmdline files (`/etc/kernel/cmdline` or per kernel cmdline files) are empty or have only white spaces.
  * Detects the `XBOOTLDR` partition **if it exists and is mounted on** `/boot`
  * Uses default configuration if the `/etc/booster-um.yaml` config **is not valid**
  * Generates UKI in `esp/EFI/Linux` dir. If this directory does not exist, it will be created
  * Removes `vmlinuz-*` and `booster-*` leftovers from `/boot` dir (**microcode** image will not be deleted)
  * Will not create separate fallback images if `universal` flag is enabled in `/etc/booster.yaml` config
  * Will not generate EFI entries or fallback UKI files. EFI entries and fallback UKI files are treated as leftovers.
  * Will not regenerate initramfs files on kernel and extramodule installations/upgrades (they are already generated by **booster hook**)
  * Removes known EFI entries (Example: `\EFI\LINUX\ARCH-LINUX.EFI`) **if efibootmgr is installed**. To prevent this, enable `efistub` in config

* booster-um libalpm hooks by default:
  * Remove EFI entries on kernel removal
  * Remove UKI files from the ESP and the sbctl database on kernel removal
  * Regenerate UKI files for all installed kernels when **booster**, **microcode**, **dkms** or **firmware** files are installed, updated, or removed
  * Will not sign generated UKI files on **microcode**, **extramodules** (`nvidia`, `nvidia-lts` etc.) and kernel updates, **sbctl hook** will do that
  * Will always sign **newly** created UKI files **if they do not exists** in the sbctl database. You don't need to manually sign or add UKI files in the sbctl database

* Default `booster-um -G` output and `/boot`|`/esp/EFI/LINUX` content:
  * <details>
    <summary>Generation of UKI files</summary>

    ![generation](https://github.com/Zile995/booster-um/assets/32335484/e726f59a-0ab3-4874-bd2b-7a7f28849c3d)

    </details>
  * <details>
    <summary>/boot and /esp/EFI/LINUX content</summary>

    ![content](https://github.com/Zile995/booster-um/assets/32335484/1ab07365-3682-4c82-b9dc-3abcb6cf240b)

    </details>

<h2 name="config_file">
    Config file
</h2>

For information about configuration, read [this documentation](https://github.com/Zile995/booster-um/blob/main/config/CONFIG.md).

<h2 name="first_run">
    First run
</h2>

* Define the `cmdline` in `/etc/booster-um.yaml` config file or create and edit the `/etc/kernel/cmdline` file. Take care to remove entries pointing to **microcode, vmlinuz and initramfs**. Here is a simple cmdline example (Change the `root=` parameter to reflect your Linux root partitions):
  ```Shell
  root=UUID=0a3407de-014b-458b-b5c1-848e92a327a3 rw quiet splash
  ```
* Edit the `/etc/booster-um.yaml` config if needed (the default configuration will be used if the config file is empty):
  * If you intend to use EFISTUB boot, add the `efistub: true` to the config. If you want to set kernel to always boot into by default, specify the kernel package name in `default_entry`
  * If you don't have secureboot keys and `sbctl` is installed, generate them with `sbctl` before generating the UKI files. `booster-um` will by default sign the UKI files with `sbctl` tool if it is installed. If you don't like that, set the `sign_uki: false` to the config.
  * If you want to use the manually generated keys, use the `sbsign` tools instead of the `sbctl`. Install the `sbsigntools` and set the `sbsign: true` to the config. The `sign_uki` must not be disabled and you will need to provide the appropriate key paths within the `sbsign_config` node (usually `secureboot_private_key` and `secureboot_certificate` fields	need to be configured)
  * For more information on creating secureboot keys, see the [UEFI/Secure Boot](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot) article
* Optionally you can delete the initramfs files of other generators, as well as the entire `esp/EFI/Linux` directory, simply by running `booster-um -C`
* Regenerate all images with `booster-um -G`
* If you have enabled the creation of EFI entries, you may need to change the boot order after generating the UKI files. You can change it like this (put your boot numbers here): `efibootmgr -o 3,1,0`
* `systemd-boot` will, if installed, detect UKI files generated by `booster-um`. For more information about booting, see the [Unified kernel image - Booting](https://wiki.archlinux.org/title/Unified_kernel_image#Booting) article

<h2 name="usage">
    Usage (help output)
</h2>

```Shell
Usage: booster-um [OPTIONS] <package>

Manage UKI files generated by booster and systemd-ukify.

Options:
    -h, --help    Show this help message
    -v, --version Print version

Generate options:
    -g <package>  Generate UKI file for specified kernel package name
    -G            Generate UKI files for all installed kernels

Remove options:
    -o            Remove orphaned EFI entries
    -r <package>  Remove UKI file for specified kernel package name
    -C            Remove initramfs*, booster*, vmlinuz* files, entire esp/EFI/Linux dir and other leftovers
    -R            Remove known booster*, vmlinuz*, UKI files and other leftovers for all installed kernels

Examples: booster-um -g linux
          booster-um -g linux linux-lts
          booster-um -r linux-zen linux-lts
          booster-um -G
          booster-um -R
          booster-um -C
```
