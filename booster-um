#!/usr/bin/env bash
# SPDX-License-Identifier: GPL-3.0-only
#
# booster-um - A simple bash script to manage UKI (Unified Kernel Image) files generated by booster and systemd-ukify
#

set -e

# Define the booster-um version
declare -g VERSION="1.7.0"

main() {
  local arg="$1"

  case "${arg}" in
    ""|-h|--help)
      show_help
      exit 0
      ;;
    -v|--version)
      show_version
      exit 0
      ;;
    *)
      (( $EUID )) &&
        $_msg_error "Please run booster-um as ${R}root${NC}." &&
        exit 1
      ;;
  esac

  # Check booster-um config
  _check_config

  # EFI dir path
  _set_efi_path

  # Find all installed kernels
  _find_kernels

  # Set initramfs config for all installed kernels
  _set_initramfs_config

  case "${arg}" in
    -g)
      # Always regenerate initramfs
      # Generate UKI file for specified kernel package name
      shift
      _generate_kernel_uki "$@"
      ;;
    -r)
      # Remove UKI file and other leftovers for specified kernel package name
      shift
      _remove_uki "$@"
      ;;
    -o)
      # Remove orphaned EFI entries
      _remove_orphaned_efi_entries
      ;;
    -C)
      # Cleanup
      # Remove initramfs*, booster*, vmlinuz* files, entire esp/EFI/Linux dir and other leftovers
      _cleanup
      ;;
    -G)
      # Always regenerate initramfs
      # Regenerate UKI files for all installed kernels
      _regenerate_all
      ;;
    -R)
      # Remove known booster*, vmlinuz*, UKI files and other leftovers for all installed kernels
      _remove_all_uki
      ;;
    -u)
      # Generate UKI file on kernel update
      # This argument is used in libalpm hook
      # The initramfs will be generated by the booster hook script
      # UKI file will not be signed if it already exists in the sbctl database
      shift
      _generate_on_update "$@"
      ;;
    *)
      $_msg_error "Unknown parameter ${R}$arg${NC} passed."
      show_help && exit 1
      ;;
  esac
  $_msg_success "Done"
}

show_help() {
  local binary="${0##*/}"
  cat << EOF
Usage: $binary [OPTIONS] <package>

Manage UKI files generated by booster and systemd-ukify.

Options:
    -h, --help    Show this help message
    -v, --version Print version

Generate options:
    -g <package>  Generate UKI file for specified kernel package name
    -G            Generate UKI files for all installed kernels

Remove options:
    -o            Remove orphaned EFI entries
    -r <package>  Remove UKI file for specified kernel package name
    -C            Remove initramfs*, booster*, vmlinuz* files, entire esp/EFI/Linux dir and other leftovers
    -R            Remove known booster*, vmlinuz*, UKI files and other leftovers for all installed kernels

Examples: $binary -g linux
          $binary -g linux linux-lts
          $binary -r linux-zen linux-lts
          $binary -G
          $binary -R
          $binary -C
EOF
}

show_version() {
  echo "${0##*/} $VERSION"
}

# Source all helper scripts
for script in /usr/share/booster-um/*; do
   . "$script"
done

main "$@"; exit