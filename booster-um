#!/usr/bin/env bash

set -e

main() {
  local arg="$1"

  case ${arg} in
    ""|-h|--help)
      show_help
      exit
      ;;
    *)
      [ $EUID -ne 0 ] &&
      echo -e "${R}==>${NC} Please run booster-um as ${R}root${NC}." >&2 && exit 1
      ;;
  esac

  # Check booster-um config
  _check_config

  # EFI dir path
  _set_efi_path

  # Find all installed kernels
  _find_kernels

  # Set initramfs config for all installed kernels
  _set_initramfs_config

  case "${arg}" in
    -g)
      # Always regenerate initramfs
      # Generate UKI file for specified kernel package name
      shift
      _generate_kernel_uki "$@"
      ;;
    -r)
      # Remove UKI file and other leftovers for specified kernel package name
      shift
      _remove_uki "$@"
      ;;
    -p)
      # This argument is used in libalpm remove hook
      # Remove orphaned EFI entries
      _remove_orphaned_efi_entries
      ;;
    -C)
      # Cleanup
      # Remove initramfs*, booster*, vmlinuz* files, entire esp/EFI/Linux dir and other leftovers
      _cleanup
      ;;
    -G)
      # Always regenerate initramfs
      # Regenerate UKI files for all installed kernels
      _regenerate_all
      ;;
    -R)
      # Remove known booster*, vmlinuz*, UKI files and other leftovers for all installed kernels
      _remove_all_uki
      ;;
    -u)
      # Generate UKI file on kernel update
      # This argument is used in libalpm hook
      # The initramfs will be generated by the booster hook script
      # UKI file will not be signed if it already exists in the sbctl database
      shift
      _generate_on_update "$@"
      ;;
    *)
      echo -e "${R}==>${NC} Unknown parameter ${R}$arg${NC} passed." >&2
      show_help && exit 1
      ;;
  esac
  echo -e "${G}==>${NC} Done."
}

show_help() {
  local command_name="${0##*/}"
  cat << EOF
Usage: $command_name [OPTIONS] <package>

Manage UKI files generated by booster and systemd-ukify.

Help options:
    -h, --help  Show this help message

Generate options:
    -g package  Generate UKI file for specified kernel package name
    -G          Generate UKI files for all installed kernels

Remove options:
    -r package  Remove UKI file for specified kernel package name
    -C          Remove initramfs*, booster*, vmlinuz* files, entire esp/EFI/Linux dir and other leftovers
    -R          Remove known booster*, vmlinuz*, UKI files and other leftovers for all installed kernels

Examples: $command_name -g linux
          $command_name -r linux
          $command_name -G
          $command_name -R
          $command_name -C
EOF
}

# Source all helper scripts
for script in /usr/share/booster-um/*; do
   . "$script"
done

main "$@"; exit