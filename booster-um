#!/usr/bin/env bash

set -e

main() {
  local arg="$1"

  case ${arg} in
    -h|--help)
      show_help
      exit
      ;;
    *)
      [ $EUID -ne 0 ] &&
      echo -e "${R}==>${NC} Please run booster-um as ${R}root${NC}." >&2 && exit 1
      ;;
  esac

  # Check booster-um config
  _check_config

  # EFI dir path
  _set_efi_path

  # Find all installed kernels
  _find_kernels

  # Flag which controls UKI signing
  sign=1

  case "${arg}" in
    -g)
      # It will always regenerate initramfs
      # Generate UKI file for specified kernel package name
      shift
      _generate_kernel_uki "$1"
      ;;
    -r)
      # Remove UKI file (and leftovers by default) for specified kernel package name
      shift
      _remove_uki "$1"
      ;;
    -G)
      # Generate UKI files for all kernels
      # It will always regenerate initramfs
      _generate_all_files
      ;;
    -R)
      # Remove booster*, vmlinuz* and UKI files for all installed kernels
      # -F argument removes mentioned files + other initramfs* files and entire esp/EFI/Linux dir
      shift
      _remove_all_files "$1"
      ;;
    -u)
      # Generate UKI file on kernel update
      # This argument must be used only in libalpm hooks
      # UKI file will not be signed if it already exists in the sbctl database
      # It will not regenerate initramfs. Initramfs will be generated on kernel update by booster hook.
      shift
      sign=0
      _generate_fallback_initramfs "$1" "$2"
      _generate_uki "$1" "$2"
      ;;
    -U)
      # It will always regenerate initramfs
      # This argument is used in libalpm hook
      # Generate UKI files for all installed kernels
      sign=0
      _generate_all_files
      ;;
    *)
      echo -e "${R}==>${NC} Unknown parameter ${R}$arg${NC} passed." >&2
      show_help && exit 1
      ;;
  esac
}

show_help() {
  local command_name="${0##*/}"
  cat << EOF
Usage: $command_name [OPTIONS] <package>

Generate or remove booster UKI files.

Help options:
    -h, --help  Show this help message

Generate options:
    -g package  Generate UKI file for specified kernel package name
    -G          Generate UKI files for all installed kernels

Remove options:
    -r package  Remove UKI file for specified kernel package name
    -R          Remove all known booster-*, vmlinuz-* files from /boot and all known files from esp/EFI/Linux dir
    -R -F       Remove all mentioned files + other initramfs* files from /boot and entire esp/EFI/Linux dir

Examples: $command_name -g linux
          $command_name -r linux
          $command_name -G
          $command_name -R
          $command_name -R -F
EOF
}

# Source all helper scripts
for script in /usr/share/booster-um/*; do
   . "$script"
done

main "$@"; exit
